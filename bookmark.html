<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>„Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ„Ç¢„Éó„É™</title>
  <style>
    body { font-family: 'Segoe UI', sans-serif; margin: 20px; background: #f9f9f9; }
    h1 { text-align: center; margin-bottom: 20px; }
    form { margin-bottom: 1em; background: #fff; padding: 15px; border-radius: 5px; 
           box-shadow: 0 1px 3px rgba(0,0,0,0.1); max-width: 600px; margin: auto; }
    input, textarea { margin: 5px 0; display: block; width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
    button { margin: 5px 5px 5px 0; padding: 6px 12px; border: none; border-radius: 4px; background: #007bff; color: #fff; cursor: pointer; }
    button:hover { background: #0056b3; }
    #searchContainer { display: flex; justify-content: center; align-items: center; gap: 12px; margin: 15px 0; }
    #searchBox { flex: 0 0 300px; padding: 6px; border: 1px solid #aaa; border-radius: 4px; }
    #tagList { text-align: center; margin: 15px 0; }
    #tagList a { margin: 0 6px; cursor: pointer; color: #007bff; text-decoration: none; }
    #tagList a.active { font-weight: bold; color: darkred; }
    table { width: 100%; border-collapse: collapse; background: #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    th, td { padding: 10px; border-bottom: 1px solid #ddd; text-align: left; }
    th { background: #f0f0f0; }
    .tags { font-size: 0.85em; color: #555; }
    .memo { font-size: 0.9em; color: #444; }
    .action-btn { background: #28a745; margin-right: 5px; }
    .delete-btn { background: #dc3545; }
  </style>
</head>
<body>
  <h1>üìë „Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ„Ç¢„Éó„É™</h1>

  <form id="bookmarkForm">
    <input type="text" id="title" placeholder="„Çø„Ç§„Éà„É´" required>
    <input type="url" id="url" placeholder="URL" required>
    <input type="text" id="tags" placeholder="„Çø„Ç∞Ôºà„Ç´„É≥„ÉûÂå∫Âàá„ÇäÔºâ">
    <textarea id="memo" placeholder="„É°„É¢" rows="2"></textarea>
    <button type="submit">ËøΩÂä†</button>
  </form>

  <div style="text-align:center; margin: 15px;">
    <button onclick="app.exportJSON()">JSON„Ç®„ÇØ„Çπ„Éù„Éº„Éà</button>
    <input type="file" id="importJSON" style="display:none" accept="application/json" onchange="app.importJSON(event)">
    <button onclick="document.getElementById('importJSON').click()">JSON„Ç§„É≥„Éù„Éº„Éà</button>
    <button onclick="app.exportCSV()">CSV„Ç®„ÇØ„Çπ„Éù„Éº„Éà</button>
    <input type="file" id="importCSV" style="display:none" accept=".csv,text/csv" onchange="app.importCSV(event)">
    <button onclick="document.getElementById('importCSV').click()">CSV„Ç§„É≥„Éù„Éº„Éà</button>
  </div>

  <div id="searchContainer">
    <input type="text" id="searchBox" placeholder="Ê§úÁ¥¢Ôºà„Çπ„Éö„Éº„ÇπÂå∫Âàá„Çä„ÅßË§áÊï∞„Ç≠„Éº„ÉØ„Éº„ÉâÔºâ">
    <label><input type="radio" name="searchMode" value="AND" checked> AND</label>
    <label><input type="radio" name="searchMode" value="OR"> OR</label>
  </div>

  <div id="tagList"></div>
  <table>
    <thead>
      <tr><th>„Çø„Ç§„Éà„É´</th><th>„Çø„Ç∞</th><th>„É°„É¢</th><th>Êìç‰Ωú</th></tr>
    </thead>
    <tbody id="bookmarkList"></tbody>
  </table>

  <script>
    // ==============================
    // Storage Strategy Classes
    // ==============================
    class StorageStrategy {
      load() { throw new Error("load() not implemented"); }
      save(data) { throw new Error("save() not implemented"); }
    }

    class LocalStorageStrategy extends StorageStrategy {
      constructor(key="bookmarks") { super(); this.key = key; }
      load() { return JSON.parse(localStorage.getItem(this.key) || "[]"); }
      save(data) { localStorage.setItem(this.key, JSON.stringify(data)); }
    }

    class MemoryStorageStrategy extends StorageStrategy {
      constructor() { super(); this.memory = []; }
      load() { return this.memory; }
      save(data) { this.memory = data; }
    }

    // ==============================
    // UI Component Classes
    // ==============================
    class TagList {
      constructor(app, el) { this.app = app; this.el = el; }
      render() {
        const tagSet = new Set();
        this.app.bookmarks.forEach(bm => {
          if (bm.tags) bm.tags.split(",").map(t => t.trim()).forEach(t => tagSet.add(t));
        });
        this.el.innerHTML = `<a onclick="app.filterByTag(null)" class="${this.app.currentTagFilter===null?'active':''}">„Åô„Åπ„Å¶</a>`;
        [...tagSet].sort().forEach(tag => {
          this.el.innerHTML += `<a onclick="app.filterByTag('${tag}')" class="${this.app.currentTagFilter===tag?'active':''}">${tag}</a>`;
        });
      }
    }

    class SearchBar {
      constructor(app, inputEl, radios) {
        this.app = app; this.inputEl = inputEl; this.radios = radios;
        this.inputEl.addEventListener("input", () => { this.app.currentSearchQuery = this.inputEl.value.toLowerCase(); this.app.render(); });
        this.radios.forEach(r => r.addEventListener("change", e => { this.app.searchMode = e.target.value; this.app.render(); }));
      }
    }

    class BookmarkList {
      constructor(app, el) { this.app = app; this.el = el; }
      render() {
        this.el.innerHTML = "";
        this.app.bookmarks
          .map((bm, idx) => ({ bm, idx }))
          .filter(({ bm }) => this.app.filterBookmark(bm))
          .forEach(({ bm, idx }) => {
            const row = document.createElement("tr");
            row.innerHTML = `
              <td><a href="${bm.url}" target="_blank">${bm.title}</a></td>
              <td class="tags">${bm.tags || "-"}</td>
              <td class="memo">${bm.memo || ""}</td>
              <td>
                <button class="action-btn" onclick="app.editBookmark(${idx})">Á∑®ÈõÜ</button>
                <button class="delete-btn" onclick="app.removeBookmark(${idx})">ÂâäÈô§</button>
              </td>`;
            this.el.appendChild(row);
          });
      }
    }

    // ==============================
    // Main App
    // ==============================
    class BookmarkApp {
      constructor(storage) {
        this.storage = storage; // ‚Üê StrategyÊ≥®ÂÖ•
        this.bookmarks = this.storage.load();
        this.editingIndex = null;
        this.currentTagFilter = null;
        this.currentSearchQuery = "";
        this.searchMode = "AND";

        // UI
        this.tagList = new TagList(this, document.getElementById("tagList"));
        this.searchBar = new SearchBar(this, document.getElementById("searchBox"), document.querySelectorAll("input[name='searchMode']"));
        this.bookmarkList = new BookmarkList(this, document.getElementById("bookmarkList"));
        this.form = document.getElementById("bookmarkForm");

        this.form.addEventListener("submit", e => this.handleSubmit(e));
        this.render();
      }

      // CRUD
      handleSubmit(e) {
        e.preventDefault();
        const title = document.getElementById("title").value.trim();
        const url = document.getElementById("url").value.trim();
        const tags = document.getElementById("tags").value.trim();
        const memo = document.getElementById("memo").value.trim();
        if (!title || !url) return;
        if (this.editingIndex !== null) {
          this.bookmarks[this.editingIndex] = { title, url, tags, memo };
          this.editingIndex = null;
          this.form.querySelector("button").textContent = "ËøΩÂä†";
        } else {
          this.bookmarks.push({ title, url, tags, memo });
        }
        this.save(); this.render(); this.form.reset();
      }
      editBookmark(index) {
        const bm = this.bookmarks[index];
        document.getElementById("title").value = bm.title;
        document.getElementById("url").value = bm.url;
        document.getElementById("tags").value = bm.tags;
        document.getElementById("memo").value = bm.memo;
        this.editingIndex = index;
        this.form.querySelector("button").textContent = "Êõ¥Êñ∞";
      }
      removeBookmark(index) { this.bookmarks.splice(index, 1); this.save(); this.render(); }
      save() { this.storage.save(this.bookmarks); }

      // FILTER
      filterByTag(tag) { this.currentTagFilter = tag; this.render(); }
      filterBookmark(bm) {
        if (this.currentTagFilter && !(bm.tags && bm.tags.split(",").map(t => t.trim()).includes(this.currentTagFilter))) return false;
        if (this.currentSearchQuery) {
          const haystack = [bm.title, bm.tags, bm.memo].join(" ").toLowerCase();
          const keywords = this.currentSearchQuery.split(/\s+/).filter(Boolean);
          return this.searchMode === "AND" ? keywords.every(k => haystack.includes(k)) : keywords.some(k => haystack.includes(k));
        }
        return true;
      }

      // RENDER
      render() { this.bookmarkList.render(); this.tagList.render(); }

      // EXPORT / IMPORT
      exportJSON() { const blob = new Blob([JSON.stringify(this.bookmarks, null, 2)], { type: "application/json" }); this.downloadFile(blob, "bookmarks.json"); }
      importJSON(event) { const file = event.target.files[0]; if (!file) return;
        const reader = new FileReader(); reader.onload = e => { try {
          const data = JSON.parse(e.target.result); if (Array.isArray(data)) { this.bookmarks = data; this.save(); this.render(); alert("JSON„Ç§„É≥„Éù„Éº„ÉàÂÆå‰∫ÜÔºÅ"); }
        } catch { alert("JSONË™≠„ÅøËæº„ÅøÂ§±Êïó"); }}; reader.readAsText(file); }
      exportCSV() {
        let csv = "„Çø„Ç§„Éà„É´,URL,„Çø„Ç∞,„É°„É¢\n";
        this.bookmarks.forEach(bm => {
          const row = [`"${(bm.title||"").replace(/"/g,'""')}"`,
                       `"${(bm.url||"").replace(/"/g,'""')}"`,
                       `"${(bm.tags||"").replace(/"/g,'""')}"`,
                       `"${(bm.memo||"").replace(/"/g,'""')}"`].join(",");
          csv += row + "\n";
        });
        this.downloadFile(new Blob([csv], { type: "text/csv" }), "bookmarks.csv");
      }
      importCSV(event) {
        const file = event.target.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = e => { try {
          const lines = e.target.result.split(/\r?\n/).slice(1);
          this.bookmarks = lines.filter(l=>l.trim()).map(line => {
            const cols = line.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(c => c.replace(/^"|"$/g,"").replace(/""/g,'"'));
            return { title: cols[0]||"", url: cols[1]||"", tags: cols[2]||"", memo: cols[3]||"" };
          });
          this.save(); this.render(); alert("CSV„Ç§„É≥„Éù„Éº„ÉàÂÆå‰∫ÜÔºÅ");
        } catch { alert("CSVË™≠„ÅøËæº„ÅøÂ§±Êïó"); }}; reader.readAsText(file);
      }
      downloadFile(blob, filename) { const url = URL.createObjectURL(blob); const a = document.createElement("a"); a.href = url; a.download = filename; a.click(); URL.revokeObjectURL(url); }
    }

    // ==============================
    // „Ç¢„Éó„É™Ëµ∑Âãï
    // ==============================
    const app = new BookmarkApp(new LocalStorageStrategy());
    // „ÉÜ„Çπ„ÉàÁî®ÈÄî„Å™„Çâ: const app = new BookmarkApp(new MemoryStorageStrategy());
  </script>
</body>
</html>
