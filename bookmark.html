<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ブックマークアプリ</title>
  <style>
    body { font-family: 'Segoe UI', sans-serif; margin: 20px; background: #f9f9f9; }
    h1 { text-align: center; margin-bottom: 20px; }
    form {
      margin-bottom: 1em; background: #fff; padding: 15px;
      border-radius: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      max-width: 600px; margin: auto;
    }
    input, textarea { margin: 5px 0; display: block; width: 100%;
      padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
    button { margin: 5px 5px 5px 0; padding: 6px 12px; border: none;
      border-radius: 4px; background: #007bff; color: #fff; cursor: pointer; }
    button:hover { background: #0056b3; }
    #searchContainer { display: flex; justify-content: center; align-items: center; gap: 12px; margin: 15px 0; }
    #searchBox { flex: 0 0 300px; padding: 6px; border: 1px solid #aaa; border-radius: 4px; }
    #tagList { text-align: center; margin: 15px 0; }
    #tagList a { margin: 0 6px; cursor: pointer; color: #007bff; text-decoration: none; }
    #tagList a.active { font-weight: bold; color: darkred; }
    table { width: 100%; border-collapse: collapse; background: #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    th, td { padding: 10px; border-bottom: 1px solid #ddd; text-align: left; }
    th { background: #f0f0f0; }
    .tags { font-size: 0.85em; color: #555; }
    .memo { font-size: 0.9em; color: #444; }
    .action-btn { background: #28a745; margin-right: 5px; }
    .delete-btn { background: #dc3545; }
  </style>
</head>
<body>
  <h1>📑 ブックマークアプリ</h1>

  <form id="bookmarkForm">
    <input type="text" id="title" placeholder="タイトル" required>
    <input type="url" id="url" placeholder="URL" required>
    <input type="text" id="tags" placeholder="タグ（カンマ区切り）">
    <textarea id="memo" placeholder="メモ" rows="2"></textarea>
    <button type="submit">追加</button>
  </form>

  <div style="text-align:center; margin: 15px;">
    <button onclick="app.exportJSON()">JSONエクスポート</button>
    <input type="file" id="importJSON" style="display:none" accept="application/json" onchange="app.importJSON(event)">
    <button onclick="document.getElementById('importJSON').click()">JSONインポート</button>
    <button onclick="app.exportCSV()">CSVエクスポート</button>
    <input type="file" id="importCSV" style="display:none" accept=".csv,text/csv" onchange="app.importCSV(event)">
    <button onclick="document.getElementById('importCSV').click()">CSVインポート</button>
  </div>

  <div id="searchContainer">
    <input type="text" id="searchBox" placeholder="検索（スペース区切りで複数キーワード）">
    <label><input type="radio" name="searchMode" value="AND" checked> AND</label>
    <label><input type="radio" name="searchMode" value="OR"> OR</label>
  </div>

  <div id="tagList"></div>
  <table>
    <thead>
      <tr>
        <th>タイトル</th>
        <th>タグ</th>
        <th>メモ</th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody id="bookmarkList"></tbody>
  </table>

  <script>
    class BookmarkApp {
      constructor() {
        this.bookmarks = JSON.parse(localStorage.getItem("bookmarks") || "[]");
        this.editingIndex = null;
        this.currentTagFilter = null;
        this.currentSearchQuery = "";
        this.searchMode = "AND";

        // DOM
        this.form = document.getElementById("bookmarkForm");
        this.list = document.getElementById("bookmarkList");
        this.tagList = document.getElementById("tagList");
        this.searchBox = document.getElementById("searchBox");

        // イベント登録
        this.form.addEventListener("submit", e => this.handleSubmit(e));
        this.searchBox.addEventListener("input", () => { this.currentSearchQuery = this.searchBox.value.toLowerCase(); this.render(); });
        document.querySelectorAll("input[name='searchMode']").forEach(radio => {
          radio.addEventListener("change", e => { this.searchMode = e.target.value; this.render(); });
        });

        this.render();
      }

      handleSubmit(e) {
        e.preventDefault();
        const title = document.getElementById("title").value.trim();
        const url = document.getElementById("url").value.trim();
        const tags = document.getElementById("tags").value.trim();
        const memo = document.getElementById("memo").value.trim();
        if (!title || !url) return;

        if (this.editingIndex !== null) {
          this.bookmarks[this.editingIndex] = { title, url, tags, memo };
          this.editingIndex = null;
          this.form.querySelector("button").textContent = "追加";
        } else {
          this.bookmarks.push({ title, url, tags, memo });
        }
        this.save();
        this.render();
        this.form.reset();
      }

      editBookmark(index) {
        const bm = this.bookmarks[index];
        document.getElementById("title").value = bm.title;
        document.getElementById("url").value = bm.url;
        document.getElementById("tags").value = bm.tags;
        document.getElementById("memo").value = bm.memo;
        this.editingIndex = index;
        this.form.querySelector("button").textContent = "更新";
      }

      removeBookmark(index) {
        this.bookmarks.splice(index, 1);
        this.save();
        this.render();
      }

      save() {
        localStorage.setItem("bookmarks", JSON.stringify(this.bookmarks));
      }

      renderTags() {
        const tagSet = new Set();
        this.bookmarks.forEach(bm => {
          if (bm.tags) bm.tags.split(",").map(t => t.trim()).forEach(t => tagSet.add(t));
        });
        this.tagList.innerHTML = `<a onclick="app.filterByTag(null)" class="${this.currentTagFilter===null?'active':''}">すべて</a>`;
        [...tagSet].sort().forEach(tag => {
          this.tagList.innerHTML += `<a onclick="app.filterByTag('${tag}')" class="${this.currentTagFilter===tag?'active':''}">${tag}</a>`;
        });
      }

      filterByTag(tag) {
        this.currentTagFilter = tag;
        this.render();
      }

      render() {
        this.list.innerHTML = "";
        this.bookmarks
          .map((bm, originalIndex) => ({ bm, originalIndex }))
          .filter(({ bm }) => {
            if (this.currentTagFilter && !(bm.tags && bm.tags.split(",").map(t => t.trim()).includes(this.currentTagFilter))) return false;
            if (this.currentSearchQuery) {
              const haystack = [bm.title, bm.tags, bm.memo].join(" ").toLowerCase();
              const keywords = this.currentSearchQuery.split(/\s+/).filter(Boolean);
              return this.searchMode === "AND" ? keywords.every(k => haystack.includes(k)) : keywords.some(k => haystack.includes(k));
            }
            return true;
          })
          .forEach(({ bm, originalIndex }) => {
            const row = document.createElement("tr");
            row.innerHTML = `
              <td><a href="${bm.url}" target="_blank">${bm.title}</a></td>
              <td class="tags">${bm.tags || "-"}</td>
              <td class="memo">${bm.memo || ""}</td>
              <td>
                <button class="action-btn" onclick="app.editBookmark(${originalIndex})">編集</button>
                <button class="delete-btn" onclick="app.removeBookmark(${originalIndex})">削除</button>
              </td>
            `;
            this.list.appendChild(row);
          });

        this.renderTags();
      }

      // ===== JSON/CSVエクスポート・インポート =====
      exportJSON() {
        const blob = new Blob([JSON.stringify(this.bookmarks, null, 2)], { type: "application/json" });
        this.downloadFile(blob, "bookmarks.json");
      }
      importJSON(event) {
        const file = event.target.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = e => {
          try {
            const data = JSON.parse(e.target.result);
            if (Array.isArray(data)) {
              this.bookmarks = data; this.save(); this.render(); alert("JSONインポート完了！");
            }
          } catch { alert("JSON読み込み失敗"); }
        };
        reader.readAsText(file);
      }

      exportCSV() {
        let csv = "タイトル,URL,タグ,メモ\n";
        this.bookmarks.forEach(bm => {
          const row = [`"${(bm.title||"").replace(/"/g,'""')}"`,
                       `"${(bm.url||"").replace(/"/g,'""')}"`,
                       `"${(bm.tags||"").replace(/"/g,'""')}"`,
                       `"${(bm.memo||"").replace(/"/g,'""')}"`].join(",");
          csv += row + "\n";
        });
        this.downloadFile(new Blob([csv], { type: "text/csv" }), "bookmarks.csv");
      }
      importCSV(event) {
        const file = event.target.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = e => {
          try {
            const lines = e.target.result.split(/\r?\n/).slice(1);
            this.bookmarks = lines.filter(l=>l.trim()).map(line => {
              const cols = line.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(c => c.replace(/^"|"$/g,"").replace(/""/g,'"'));
              return { title: cols[0]||"", url: cols[1]||"", tags: cols[2]||"", memo: cols[3]||"" };
            });
            this.save(); this.render(); alert("CSVインポート完了！");
          } catch { alert("CSV読み込み失敗"); }
        };
        reader.readAsText(file);
      }

      downloadFile(blob, filename) {
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url; a.download = filename; a.click();
        URL.revokeObjectURL(url);
      }
    }

    // アプリ起動
    const app = new BookmarkApp();
  </script>
</body>
</html>
